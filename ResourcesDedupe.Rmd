---
title: "Dedupe Resource List"
output: html_notebook
---

```{r libraries, include=FALSE}
library(tidyverse)
```


# Purpose 
Dedupe Resource Lists for Covid and resource directory.

The plan is to first dedupe the Organization names and create an Org ID. Then use Org ID and Program name to dedupe programs.



# Prework

Ran both lists of data "Master-Agency-Finder" and "ResourcesCovid" though OpenRefine and clustered the org names. 



```{r Import data, include=FALSE}
#Agency Finder
resources <- read_csv("data/MasterList-Agency-Finder.csv")

#Covid resources
covid_res <- read_csv("data/ResourcesCOVID.csv")
```



Rename first column of resources to identify data.

```{r}
resources <- rename(resources, 'MSheetID' = 'Column'  )
```


Combine two sheets into one dataframe for preparation in the Dedupe of Orgs.

Step1: shorten dataframes into only the necessary columns for the dedupe of orgs.


```{r}
covid_res.df <- select(covid_res, CSheetID, Org, 'Program Name', 'Street Address', City, Zip )

covid_res.df <- rename(covid_res.df, c('ID' = 'CSheetID', 'Org' = 'Org', 'Program' = 'Program Name','Street' ='Street Address'))
```




```{r}
resources.df <- select(resources, MSheetID, `Organization Name`, 'Program Name', 'Street Address', City, Zip)

resources.df<- rename(resources.df, c('ID' = 'MSheetID', 'Org' = 'Organization Name', 'Program' = 'Program Name', 'Street' = 'Street Address' ))
```


Step2: combine table rows

```{r}
comb_res <- bind_rows( covid_res.df, resources.df)
```

Replace error with zip endding in '.0'

```{r}
comb_res <- comb_res %>% 
  mutate(Zip= str_remove(Zip, "\\.0"))
```




export file out
```{r}
#write_csv(comb_res, "data/comb_res.csv")
```



import clusters from dedupe Step

```{r}
program_clusters <- read_csv("data/Org Resource List.csv")
```



Add Cluster Ids to resource columns
```{r}
# create df's to store new tables

resources.Clustered <- resources

covid_res.clustered <- covid_res

```



create joining table
```{r}
cluster_join <- select(program_clusters, cluster_id, id)
```


left joins
```{r}
resources.Clustered <- left_join(resources.Clustered, cluster_join, by= c('MSheetID'= 'id'))

#relocate joined cluster column to position 2
resources.Clustered <- resources.Clustered %>% 
  relocate(cluster_id, .after = MSheetID)
```

```{r}
covid_res.clustered<- left_join(covid_res.clustered, cluster_join, by = c("CSheetID"='id'))


# relocate cluster id column to position 2
covid_res.clustered <- covid_res.clustered %>% 
  relocate(cluster_id, .after = CSheetID)

```



Count number of distinct programs
```{r}
n_distinct(cluster_join$cluster_id)

```

```{r}
n_distinct(covid_res.clustered$cluster_id)

n_distinct(resources.Clustered$cluster_id)
```

```{r}
covid.unique<- as_tibble(  unique(covid_res.clustered$cluster_id))

resources.unique <- as_tibble(unique(resources.Clustered$cluster_id))
```


```{r}
nonJoinCR <- anti_join(covid.unique, resources.unique)

nonJoinRC <- anti_join(resources.unique, covid.unique)
```


```{r}
explore_covid <-filter(covid_res.clustered, cluster_id %in% nonJoinCR$value)
```

```{r}
explore_res <- filter(resources.Clustered, cluster_id %in% nonJoinRC$value)
```


```{r}
programs_add <-filter(explore_covid, Org != 'Guilford County Schools')
```


Will add 17 programs from Covid resource list to master resource list.


Then extract orgs from that list.


Extract Service types from that unique list as well.


First exact subset of columns to combine from both lists. 

```{r}
# subset of resources list
resource.comb <- select(
  resources.Clustered,
  cluster_id,
  'Program Name',
  'Organization Name'
  
)

resource.comb <- rename(resource.comb, 'Org' ='Organization Name')

```



```{r}
covid.comb <- select(
  covid_res.clustered,
  cluster_id,
  'Program Name',
  Org
)
```


```{r}
#filter covid.comb to just the programs to add
covid.comb.add <-filter(
  covid.comb,
  cluster_id %in% programs_add$cluster_id
)

```






```{r}
# combine sublist together
Master_Resource_List <- bind_rows(resource.comb, covid.comb.add)
```


Function to add all appearances.
```{r}
appearances_list<- function(clustId){
  clusters = cluster_join
  
  clusters<- clusters %>% 
    filter( cluster_id==clustId)
  
  a = as.vector(clusters$id)
  
  
 return( paste0(a, collapse = ";  "))
  
}

appearances_list_vector <- Vectorize(appearances_list)
```


sanity check
```{r}
test.clusters<-count(cluster_join, cluster_id)

test2 <- filter(cluster_join, cluster_id =='ae0abbbc-a00d-4d21-ac6a-73764881e9b8')

```



```{r}
appearances_list('ae0abbbc-a00d-4d21-ac6a-73764881e9b8')
```
Passed sanity check



```{r}
#combine apperances in master list
Master_Resource_List<- Master_Resource_List %>% 
  mutate(sources = appearances_list_vector(cluster_id))

```



```{r}
#remove duplicates and grad first instance only
Master_Resource_List <- Master_Resource_List %>% 
  group_by(cluster_id) %>% 
  summarise(Progam = first(`Program Name`),
            Org = first(Org),
            sources= first(sources))
```



```{r}
# count the number of sources

Master_Resource_List <-Master_Resource_List %>% 
  mutate(n_sources= str_count(sources,';') + 1) %>%  # total number of sources
  mutate(M_n_sources = str_count(sources, 'M')) %>%  # num of sources from resources
  mutate(C_n_sources = str_count(sources,'C'))      # num of sources from covid list   

```



```{r}
Master_Resource_List.test<- Master_Resource_List %>% 
  filter(n_sources==2)
```


Add addresses to programs to aide in Org dedupe

Create a subset of resources with just the address fields we need

```{r}

resources.Addresses <- resources.Clustered %>% 
  select(MSheetID, cluster_id, `Street Address`, City, Zip)
```

Ensure only one cluster in the resources.
```{r}
Remove_values <- Master_Resource_List %>% 
  filter(M_n_sources>1)

Remove_values<- Remove_values$cluster_id
```

```{r}
resources.Addresses <- resources.Addresses %>% 
  filter(!cluster_id %in% Remove_values)
```




left join of the data sets with Master_List


```{r}
Master_Resource_List <- left_join(Master_Resource_List, resources.Addresses, by= "cluster_id")
```





Rename cluster_id because we will run this though a second dedupe

```{r}
Master_Resource_List <- Master_Resource_List %>% 
  rename('cluster_id_program' = 'cluster_id')
```














Creat list of Orgs from Master List

```{r}
#write_csv(Master_Resource_List, "data/Master_Resource_list.csv")
```



import Orgs clustered
```{r}
Org_master_list <- read_csv('data/Org_Master_List_Clustered.csv')


Org_master_list<- Org_master_list %>% 
  rename('cluster_id_Org'='cluster_id')
```


Dedupe Org List

```{r}
Org_master_list.Dedupe <- Org_master_list %>% 
  group_by(cluster_id_Org) %>% 
  summarise(Org= first(org),
            street_address=first(street_address),
            city= first(city),
            zip = first(zip),
            n_sources= first(n_sources))

```

```{r}
na_Org_addresses<- Org_master_list.Dedupe %>% 
  filter(is.na(street_address))
```


```{r}
#write table for master list

#write_csv(Org_master_list, 'data/org_master_list.csv')
```



Create Program List
```{r}
program_list <- resource.comb %>% 
  rename(cluster_id_program = cluster_id) %>% 
  group_by(cluster_id_program) %>% 
  summarise(cluster_id_program = first(cluster_id_program),
            Program_Name = first(`Program Name`))
```

```{r}
program_list.test <- left_join(program_list, Master_Resource_list, by = "cluster_id_program")

```


```{r}
Org_master_list.comb <- select(Org_master_list,
                               cluster_id_program,
                               cluster_id_Org,)



program_list.test2 <- left_join(program_list.test, Org_master_list.comb, by = "cluster_id_program")
```

Combine from Agency Finder

```{r}
program_list.test3 <- left_join(program_list.test2, MasterList_Agency_Finder, by= c('MSheetID'= 'Column'))
```



```{r}
write_csv(Org_master_list.Dedupe, 'data/orgl_list_upload.csv')

write_csv(program_list.test3, 'data/program_list.csv')
```




